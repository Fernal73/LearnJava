#! /usr/bin/env bash

#######################################################################
#@author: Linus Fernandes(linusfernandes @gmail.com)
# @file: build
## @created: Friday May 03, 2019 21: 20: 25 IST
# @copyright: Copyright(c) Linus Fernandes
## @description: 
######################################################################
usage() {
        echo "usage: build dir"
        echo "dir - Project directory, must exist"
        exit 1
}

isDX ()
{
  type dx &>/dev/null
  return $?
}

isJVM ()
{
  type jar &>/dev/null
  return $?
}

createDex()
{
  rm -rf $proj/dist || \
    { echo "Unable to delete folder $proj/dist"; }
  dx --dex --output=$proj.dex $proj && \
    mkdir $proj/dist && \
    cp $proj.dex $proj/dist && exit 0 || \
    { echo "Error creating dex output"; }
  dxRes=$?
}

createJar()
{
  cd $proj || echo "cannot cd to $proj";
  jar cfnm $proj.jar manifest.mf \
    `find . -name "*.class" \
    ! -path "*.git*" ! -type d` || \
    { echo "Error creating jar output: $proj.jarRes"; }
  jarRes=$? 
  [ -e $proj.jar ] && cp $proj.jar .. \
    && mkdir -p dist && mv $proj.jar dist || \
    { echo "Error moving jar file to $proj/dist"; }
  cd ..
  exit 0
}

proj=$1
ver="1.7"
isDX
dex=$?
isJVM
jvm=$?
dxRes=0
jarRes=0
if [ -z $proj ] || [ ! -d $proj ]
  then
    usage
else
    echo $proj
    [ -e $proj/.ver ] && \
      { ver=$(cat $proj/.ver) || \
      echo "Unable to read $proj/.ver";}
    ecj -$ver $proj 
    success=$?
    if [ $success -eq 0 ]
      then
      if [ $dex -eq 0 ]
        then
        createDex
      fi
      if [ $jvm -eq 0 ]
        then
        createJar
      fi
    fi
fi
exit `expr $success + $dxRes + $jarRes`
